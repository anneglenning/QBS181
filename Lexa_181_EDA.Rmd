---
title: "Lexa_181_analysis"
author: "Alexandra Treml"
date: "2024-11-01"
output: html_document
---
1. Look at rural counties versus non-rural
  a. Do rural communities exercise less? 
  b. Do rural communities have better air quality on average? 
  c. Do rural communities have a higher rate of 'limited healthy food'? 
  
  
  pesticides and pollution runoff in water, etc 
  do cities have better water filtering? 
  nitrogen runoff 
  organic vs regular farming 

The assumption is that rural communities have better air quality due to the lack of city smog and pollution. However, in farming communities, fertilizer and nitrogen runoff impact water and soil quality, pesticides dramatically affect air quality, food deserts are more prevalent, trendy workout centers are less prolific, and medical care is possibly not affordable, frowned upon, or not available.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(dplyr)
library(tidyverse)
library(ggplot2)
library(sf)
library(tigris)

#install.packages("plotly")
library(plotly)
```


```{r}
#DATA LOADING AND CLEANING
load("final_data.Rdata")
df <- county_data
df <- df %>%
  mutate(FIPS = sprintf("%05d", as.numeric(FIPS)))

#FOR STATE AGGREGATIONS
by_state <- df %>%
  group_by(State) %>% 
  summarize(across(everything(), mean, na.rm = TRUE)) %>%
  select(-FIPS, -County)
#head(by_state)

#a. do rural communities have less access to exercise? Yes
#b. Are rural communities more likely to be obese? #very slight increase in adult obesity in rural areas
#c. Do rural communities have better air quality?  No 


#scatterplot of access to exercise and rurality
ggplot(df, aes(x = rural_2020, y = access_to_exercise_2020)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "red") + 
  labs(title = "Scatterplot of Access to Exercise vs. Rurality",
       x = "Rurality (rural_2020)",
       y = "Access to Exercise") +
  theme_minimal()

#scatterplot of good days aqi and rural 
ggplot(df, aes(x = rural_2020, y = good_days)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "blue") +  
  labs(title = "Scatterplot of Good Days vs. Rurality",
       x = "Rurality (rural_2020)",
       y = "Number of Good Days") +
  theme_minimal()


#scatterplot of adult obesity and rurality
ggplot(df, aes(x = rural_2020, y = adult_obesity_2020)) +
  geom_point() +
  geom_smooth(method = "lm", se = FALSE, color = "green") +  
  labs(title = "Scatterplot of Adult Obesity vs. Rurality",
       x = "Rurality (rural_2020)",
       y = "Obesity %") +
  theme_minimal()

#spearman test for rurality and obesity 
spearman_obesity_rurality <- cor.test(df$adult_obesity_2020, df$rural_2020, method = "spearman")
spearman_obesity_rurality 
#results: p value is significant, so there is a moderately positive relationship between obesity and rurality

#Since obesity is significantly correlated with rurality, let's see how air quality correlates.  

```
```{r}
df$good_days <- as.numeric(df$good_days)


ggplot(df, aes(x = rural_2020, y = adult_obesity_2020)) +
  geom_point(aes(color = median_aqi)) +
  labs(title = "Adult Obesity vs. Rurality with Good Air Quality",
       x = "Rurality",
       y = "Adult Obesity %") +
  scale_color_gradient(low = "red", high = "green")+
  theme_minimal()
```

```{r}
#install.packages("corrplot")
library(corrplot)
#install.packages("ggcorrplot")
library(ggcorrplot)

df_num <- df %>%
  select(-FIPS, -County, -State, -access_to_exercise_2020, -acsc_admit_rate_2020, -adult_diabetic_rate_2020,-dentist_rate_2020, -driving_mortality_2020, -chlamydia_2020, -dci_score_2020, -dui_deaths_2020, -excess_drinking_2020, -fair_or_poor_health_2020, -food_env_index_2020, -food_insecure_2020, -food_insecure_2020, -free_reduced_lunch_2020, -injury_death_rate_2020, -limited_healthy_food_2020, -mammogram_2020, -minor_2020, -over_65_2020, - pcp_rate_2020, -severe_housing_prob_2020, -smoking_rate_2020, -social_association_rate_2020, -teen_birth_rate_2020,  -unemployment_2020, -uninsured_2020, -uninsured_v2_2020, -ypll_2020, -Year, -"90th_percentile_aqi", -co_days, -no2_days, -ozone_days, -pm2.5_days, -pm10_days, -age_adj_mortality_2020, -unhealthy_days, -unhealthy_for_sensitive_groups_days, -phys_inactive_2020, -injury_death_rate_2020, -income_ratio_2020, -adult_diabetic_rate_2020, -adult_obesity_2020)

cor_matrix <- cor(df_num, use = "complete.obs")
print(cor_matrix)

ggcorrplot(cor_matrix, lab = TRUE, lab_size = 1,
           colors = c("red", "white", "blue"),
           title = "Correlation Matrix")
```


```{r}
#static counties, hazardous air quality days 
options(tigris_use_cache = TRUE)  # Caches shapefiles for faster loading in future
us_counties <- counties(cb = TRUE, year = 2021, class = "sf")

data <- df %>%
  mutate(FIPS = as.character(FIPS))

us_counties <- us_counties %>%
  mutate(FIPS = as.character(GEOID))  # GEOID is the FIPS column in `us_counties`

map_data <- left_join(us_counties, data, by = "FIPS")
map_data


ggplot(map_data) +
  geom_sf(aes(fill = median_aqi), color = "white", size = 0.1) +
  scale_fill_gradientn(colors = c("green", "yellow", "red")) +
  labs(title = "Median AQI by County") +
  #coord_sf(xlim = c(-80, -66), ylim = c(38, 47), expand = FALSE) +  # Northeast bounds
  #coord_sf(xlim = c(-125, -66), ylim = c(24, 50), expand = FALSE) +  # Limits for continental U.S.
  #coord_sf(xlim = c(-105, -80), ylim = c(36, 49), expand = FALSE) + #Midwest
  #coord_sf(xlim = c(-106, -75), ylim = c(25, 39), expand = FALSE) + #South
  coord_sf(xlim = c(-125, -102), ylim = c(31, 49), expand = FALSE) + #West
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )
```
```{r}
#dynamic county 
p <- ggplot(map_data) +
  geom_sf(aes(fill = median_aqi, text = paste("County:", County, "<br>State:", State, "<br>AQI:", median_aqi, "%")), 
          color = "white", size = 0.1) +
  scale_fill_gradientn(colors = c("green", "yellow", "red")) +
  labs(title = "Median AQI by County in 2020") +
  coord_sf(xlim = c(-125, -66), ylim = c(24, 50), expand = FALSE) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

# Convert to interactive plot with plotly
ggplotly(p, tooltip = "text")
```
```{r}
#by state
us_states <- states(cb = TRUE, year = 2021, class = "sf")
state_data <- left_join(us_states, by_state, by = c("NAME" = "State"))
head(state_data)

p <- ggplot(state_data) +
  geom_sf(aes(fill = good_days, text = paste("Good days AQI:", round(good_days, 1))), color = "white", size = 0.1) +
  scale_fill_gradientn(colors = c("green", "yellow", "red"), name = "Good AQI (%)")+
  labs(title = "Good AQI by State in 2020") +
  coord_sf(xlim = c(-125, -66), ylim = c(24, 50), expand = FALSE) +
  theme_minimal() +
  theme(
    legend.position = "bottom",
    axis.text = element_blank(),
    axis.ticks = element_blank(),
    panel.grid = element_blank()
  )

# Convert to interactive plot with plotly
ggplotly(p, tooltip = "text")

```
```{r}
# Load required packages
library(shiny)
library(plotly)

# Define UI
ui <- fluidPage(
    titlePanel("My Plotly Graphs in Shiny"),
    
    sidebarLayout(
        sidebarPanel(
            # Input elements can go here (e.g., sliders, dropdowns) if you want interactivity
        ),
        
        mainPanel(
            plotlyOutput("myPlot")  # Output plotly graph
        )
    )
)

# Define server logic
server <- function(input, output) {
    
    # Create a Plotly graph (example)
    output$myPlot <- renderPlotly({
        # Here, replace this with your existing plotly graph code
        plot_ly(data = mtcars, x = ~wt, y = ~mpg, type = 'scatter', mode = 'markers')
    })
}

# Run the app
shinyApp(ui = ui, server = server)
```

